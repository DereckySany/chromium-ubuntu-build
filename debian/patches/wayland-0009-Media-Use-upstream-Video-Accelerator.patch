From 1238b55e0e8b2d5529c81ec3371986f81889dc57 Mon Sep 17 00:00:00 2001
From: Kalyan Kondapally <kalyan.kondapally@intel.com>
Date: Tue, 15 Sep 2015 01:34:13 -0700
Subject: [PATCH 09/13] Media: Use upstream Video Accelerator.

---
 chrome/browser/password_manager/password_store_factory.cc |  2 +-
 content/common/gpu/media/gpu_video_decode_accelerator.cc  | 10 +++-------
 content/common/sandbox_linux/bpf_gpu_policy_linux.cc      |  2 +-
 3 files changed, 5 insertions(+), 9 deletions(-)

Index: dev.wily/content/common/gpu/media/gpu_video_decode_accelerator.cc
===================================================================
--- dev.wily.orig/content/common/gpu/media/gpu_video_decode_accelerator.cc
+++ dev.wily/content/common/gpu/media/gpu_video_decode_accelerator.cc
@@ -44,7 +44,8 @@
 #include "ui/gl/gl_implementation.h"
 #endif
 #elif defined(USE_OZONE)
-#include "media/ozone/media_ozone_platform.h"
+#include "content/common/gpu/media/vaapi_video_decode_accelerator.h"
+#include "ui/gl/gl_implementation.h"
 #elif defined(OS_ANDROID)
 #include "content/common/gpu/media/android_copying_backing_strategy.h"
 #include "content/common/gpu/media/android_deferred_rendering_backing_strategy.h"
@@ -438,7 +439,7 @@ void GpuVideoDecodeAccelerator::BindImag
 scoped_ptr<media::VideoDecodeAccelerator>
 GpuVideoDecodeAccelerator::CreateVaapiVDA() {
   scoped_ptr<media::VideoDecodeAccelerator> decoder;
-#if defined(OS_CHROMEOS) && defined(ARCH_CPU_X86_FAMILY)
+#if defined(USE_OZONE) && defined(ARCH_CPU_X86_FAMILY)
   decoder.reset(new VaapiVideoDecodeAccelerator(
       make_context_current_, base::Bind(&GpuVideoDecodeAccelerator::BindImage,
                                         base::Unretained(this))));
@@ -460,11 +461,6 @@ GpuVideoDecodeAccelerator::CreateVTVDA()
 scoped_ptr<media::VideoDecodeAccelerator>
 GpuVideoDecodeAccelerator::CreateOzoneVDA() {
   scoped_ptr<media::VideoDecodeAccelerator> decoder;
-#if !defined(OS_CHROMEOS) && defined(USE_OZONE)
-  media::MediaOzonePlatform* platform =
-      media::MediaOzonePlatform::GetInstance();
-  decoder.reset(platform->CreateVideoDecodeAccelerator(make_context_current_));
-#endif
   return decoder.Pass();
 }
 
Index: dev.wily/content/common/sandbox_linux/bpf_gpu_policy_linux.cc
===================================================================
--- dev.wily.orig/content/common/sandbox_linux/bpf_gpu_policy_linux.cc
+++ dev.wily/content/common/sandbox_linux/bpf_gpu_policy_linux.cc
@@ -314,7 +314,7 @@ bool GpuProcessPolicy::PreSandboxHook()
         dlopen(I965HybridDrvVideoPath, RTLD_NOW|RTLD_GLOBAL|RTLD_NODELETE);
       dlopen("libva.so.1", RTLD_NOW|RTLD_GLOBAL|RTLD_NODELETE);
 #if defined(USE_OZONE)
-      dlopen("libva-drm.so.1", RTLD_NOW|RTLD_GLOBAL|RTLD_NODELETE);
+      dlopen("libva-wayland.so.1", RTLD_NOW|RTLD_GLOBAL|RTLD_NODELETE);
 #elif defined(USE_X11)
       dlopen("libva-x11.so.1", RTLD_NOW|RTLD_GLOBAL|RTLD_NODELETE);
 #endif
